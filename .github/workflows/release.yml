name: ğŸš€ Release Packages ğŸ‰

on:
  push:
    tags:
      - 'v*'  # ä»…åœ¨æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ¤– Checkout code
      uses: actions/checkout@v2
      with:
        lfs: true  # ç¡®ä¿æ‹‰å– LFS æ–‡ä»¶

    - name: âš™ï¸ Set up variables
      run: |
        set -e  # åœ¨å‡ºç°é”™è¯¯æ—¶ç«‹å³é€€å‡º
        COMMON_FILES="addons conf docs offline utils *.sh README.md"

        get_included_dirs() {
            local root_dir="$1"
            shift
            local exclude_dirs=("$@")
            local included_dirs=()

            for dir in "$root_dir"/*; do
                if [[ -d "$dir" ]]; then
                    local dir_name=$(basename "$dir")
                    if [[ ! " ${exclude_dirs[*]} " =~ " ${dir_name} " ]]; then
                        included_dirs+=("$dir")
                    fi
                fi
            done
            echo "${included_dirs[*]}"
        }

        INCLUDED_DIRS=("cni" "docker-compose")
        # è·å–æ’é™¤çš„ç›®å½•
        EXCLUDE_ONLINE=$(get_included_dirs "offline" "${INCLUDED_DIRS[@]}")
        EXCLUDE_1_23_3=("offline/k8s/1.28.2" "offline/crictl-images/1.28.2")
        EXCLUDE_1_28_2=("offline/k8s/1.23.3" "offline/crictl-images/1.23.3")

        release_body="Release ${GITHUB_REF} - New features and improvements."

        # å°†ç¯å¢ƒå˜é‡å†™å…¥
        echo "COMMON_FILES=${COMMON_FILES}" >> $GITHUB_ENV
        echo "EXCLUDE_ONLINE=${EXCLUDE_ONLINE[*]}" >> $GITHUB_ENV
        echo "EXCLUDE_1_23_3=${EXCLUDE_1_23_3[*]}" >> $GITHUB_ENV
        echo "EXCLUDE_1_28_2=${EXCLUDE_1_28_2[*]}" >> $GITHUB_ENV
        echo "release_body=${release_body}" >> $GITHUB_ENV

    - name: ğŸ” Get commit ID and tag name
      id: get_info
      run: |
        echo "Fetching commit ID and tag name..."
        commit_id=$(git rev-parse --short HEAD)
        tag_name=$(git describe --tags --abbrev=0)
        echo "commit_id=${commit_id}" >> $GITHUB_ENV
        echo "tag_name=${tag_name}" >> $GITHUB_ENV  # ä½¿ç”¨ git å‘½ä»¤è·å–å½“å‰æ ‡ç­¾å
        echo "filename_prefix=tarzan-${tag_name}-${commit_id}" >> $GITHUB_ENV  # åˆ›å»ºæ–‡ä»¶åå‰ç¼€
        echo "Fetched commit ID: ${commit_id} and tag name: ${tag_name}"
    - name: ğŸ“¦ Create tar.gz archive
      run: |
        set -e
        run_command() {
          echo "Running command: $*"
          "$@" 2>&1 | tee /tmp/command_output.log
        }

        create_tar() {
          local output=$1
          local transform_prefix=$2
          shift 2
          local exclude_args=()
          for exclude in "$@"; do
            exclude_args+=(--exclude="$exclude")
          done
          echo "Creating archive: ${output} with prefix: ${transform_prefix}"
          run_command tar -czvf "${output}" --transform="s,^,${transform_prefix}/," "${exclude_args[@]}" $COMMON_FILES
        }

        # ä½¿ç”¨ commit ID å’Œ tag åç§°åˆ›å»º tar.gz æ–‡ä»¶

        create_tar "${{ env.filename_prefix }}-online.tar.gz" "tarzan-online" ${{ env.EXCLUDE_ONLINE }}
        create_tar "${{ env.filename_prefix }}-offline-1.23.3.tar.gz" "tarzan-offline-1.23.3" ${{ env.EXCLUDE_1_23_3 }}
        create_tar "${{ env.filename_prefix }}-offline-1.28.2.tar.gz" "tarzan-offline-1.28.2" ${{ env.EXCLUDE_1_28_2 }}
        create_tar "${{ env.filename_prefix }}-offline-multiple.tar.gz" "tarzan-offline-multiple"

    - name: ğŸ“¤ Upload Release Assets
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_TOKEN: ${{ secrets.GH_PAT_TOKEN }}
      with:
        tag_name: ${{ github.ref }}  # ä½¿ç”¨å½“å‰æ ‡ç­¾ä½œä¸ºå‘å¸ƒçš„æ ‡ç­¾
        name: Release ${{ github.ref }}  # å‘å¸ƒåç§°
        body: ${{ env.release_body }}  # ä½¿ç”¨å˜é‡ä½œä¸ºå‘å¸ƒè¯´æ˜
        draft: false  # ä¸åˆ›å»ºè‰ç¨¿
        prerelease: false  # ä¸æ ‡è®°ä¸ºé¢„å‘å¸ƒ
        files: |
          ${{ env.filename_prefix }}-online.tar.gz
          ${{ env.filename_prefix }}-offline-1.23.3.tar.gz
          ${{ env.filename_prefix }}-offline-1.28.2.tar.gz
          ${{ env.filename_prefix }}-offline-multiple.tar.gz
